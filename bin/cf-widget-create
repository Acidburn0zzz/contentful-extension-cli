#!/usr/bin/env node

'use strict';

var yargs = require('yargs');
var url = require('url');
var Contentful = require('contentful-management');
var http = require('../lib/cli/http');
var create = require('../lib/cli/command/create');

let token = process.env.CONTENTFUL_MANAGEMENT_ACCESS_TOKEN;

if (!token) {
  console.error('CONTENTFUL_MANAGEMENT_ACCESS_TOKEN is undefined or empty');
  process.exit(1);
}

yargs
.reset()
.options({
  'space-id': {
    required: true,
    description: 'Id of a space in Contentful',
    type: 'string',
    requiresArg: true
  },
  'srcdoc': {
    description: 'Path to widget bundle',
    type: 'string',
    requiresArg: true
  },
  'src': {
    description: 'URL to widget bundle',
    type: 'string',
    requiresArg: true
  },
  'id': {
    description: 'Widget id',
    type: 'string',
    requiresArg: true
  },
  'name': {
    description: 'Widget name',
    type: 'string',
    requiresArg: true
  },
  'descriptor': {
    description: 'Path to a widget descriptor file',
    type: 'string',
    requiresArg: true
  },
  'field-types': {
    description: 'List of field types where to use the widget',
    type: 'array',
    requiresArg: true
  },
  'sidebar': {
    description: 'Render the widget in the sidebar',
    type: 'boolean',
    default: undefined
  },
  'host': {
    description: 'API host',
    type: 'string',
    requiresArg: true
  }
});

let argv = yargs.argv;
let options = {};

options.src = argv.src;
options.srcdoc = argv.srcdoc;
options.id = argv.id;
options.name = argv.name;
options.spaceId = argv.spaceId;
options.descriptor = argv.descriptor;
options.fieldTypes = argv.fieldTypes;
options.sidebar = argv.sidebar;

let urlInfo = url.parse(argv.host || 'https://api.contentful.com');
let host = urlInfo.host;
let isSecure = urlInfo.protocol === 'https:';

let client = Contentful.createClient({
  accessToken: token,
  host: host,
  secure: isSecure
});

let context = {
  client: client,
  http: http
};

create(options, context);
